<script>
  function toggleServiceNumberInput() {
    const selected = document.querySelector('input[name="service"]:checked').value;
    const div = document.getElementById('serviceNumberDiv');
    div.classList.toggle('hidden', selected !== 'NUMBER');
  }

  async function upload() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('Please select a video file.');

    const driverName = document.getElementById('driverName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phase = document.querySelector('input[name="phase"]:checked').value;
    const service = document.querySelector('input[name="service"]:checked').value;
    const serviceNumber = document.getElementById('serviceNumber').value.trim();

    if (!driverName || !email) {
      alert('Please fill in all required fields.');
      return;
    }

    const fileName = `${Date.now()}_${driverName.replace(/\s/g, "_")}_${file.name}`;

    let uploadUrl;

    try {
      const res = await fetch('/api/get-upload-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          fileName,
          fileType: file.type
        })
      });

      if (!res.ok) {
        const text = await res.text(); // debug info
        console.error("Server error response:", text);
        throw new Error('Server error while generating upload URL');
      }

      const json = await res.json();
      uploadUrl = json.uploadUrl;
    } catch (err) {
      console.error("Failed to get upload URL:", err);
      alert("❌ Failed to get upload URL.");
      return;
    }

    try {
      const uploadRes = await fetch(uploadUrl, {
        method: 'PUT',
        headers: { 'Content-Type': file.type },
        body: file
      });

      if (uploadRes.ok) {
        alert('✅ Upload completed successfully!');
      } else {
        alert('❌ Upload failed!');
      }
    } catch (err) {
      console.error("Upload error:", err);
      alert("❌ Upload failed due to network error.");
    }
  }
</script>
